<div [@routerTransition]>
    <app-page-header [heading]="'Fleet availability'" [icon]="'fa-ship'"></app-page-header>
    <div class="row" *ngIf="tokenInfo.userPermission == 'admin' || tokenInfo.userPermission == 'Logistics specialist' || tokenInfo.userPermission == 'Marine controller'">
        <div class="col-lg-8">
            <canvas id="canvas">{{myChart}}</canvas>
        </div>
    </div>
    <div class="card-body table-responsive" *ngIf="loaded">
        <select class="monthSelector" (change)="setMonth($event.target.value)">
            <option *ngFor="let date of availableMonths" [value]="date" [selected]="selectedMonth==date">{{date}}</option>
        </select>
        <span><button *ngIf="tokenInfo.userPermission == 'admin' || tokenInfo.userPermission == 'Logistics specialist'" class="btn addVessel"
                      (click)="openModal(addVesselModal)">Add vessel</button></span>
        <ng-template #addVesselModal let-modal>
            <div class="modal-header">
                <h4 class="modal-title">Add vessel</h4>
                <button type="button" class="close" aria-label="Close" (click)="closeModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-content">
                        <select class="form-control" name="type" [(ngModel)]="vesselToAdd.type">
                            <option value="existing">Vessel in our BMO database</option>
                            <option value="new">New vessel</option>
                        </select>
                        <div class="form-group" *ngIf="vesselToAdd.type=='existing'">
                            Vessel in our BMO database
                            <input type="text" class="form-control" [ngbTypeahead]="search" (focus)="focus$.next($event.target.value)"
                                   #instance="ngbTypeahead" [(ngModel)]="vesselToAdd.existingVesselValue" name="existingVessel" />
                        </div>
                        <div class="form-group" *ngIf="vesselToAdd.type=='new'">
                            New vessel
                            <input name="newVessel" class="form-control" placeholder="Mmsi or Vessel name" [(ngModel)]="vesselToAdd.newVesselValue" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                Changes could take up to a day to process
                <button type="button" class="btn btn-primary" (click)="addVessel()">Submit</button>
            </div>
        </ng-template>
        <span><button *ngIf="tokenInfo.userPermission == 'admin' || tokenInfo.userPermission == 'Logistics specialist'" class="btn addVessel"
                      (click)="openModal(setActiveModal, {size: 'lg'}, true)">Set active</button></span>
        <ng-template #setActiveModal let-modal>
            <div class="modal-header setActiveHeader">
                <h4 class="modal-title">Set active</h4>
                <ng-template #popTitle>Help</ng-template>
                <ng-template #popContent class="helpContent">
                    <br />
                    Here you can set the active days of a vessel and set which vessel is currently active.
                    A vessel is active if the current date falls within an active period.
                    Leave the starting date empty to set it as the start of the campaign;
                    Leave the end date empty to set it as the end of the campaign.
                    <!--These will be updated if the campaign is extended.-->
                </ng-template>
                <button type="button" class="btn btn-outline-secondary helpBtn" [autoClose]="true" [ngbPopover]="popContent" [popoverTitle]="popTitle" placement="left" popoverClass="helpPopup">?</button>
                <button type="button" class="close closeBtn" aria-label="Close" (click)="closeModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table>
                    <ng-container *ngFor="let vessel of turbineWarrenty.fullFleet; let i = index">
                        <tr (click)="openActiveListings(vessel)" class="pointer">
                            <td>
                                <span class="arrow" [class.arrow-down]="!isOpen(vessel)" [class.arrow-up]="isOpen(vessel)"></span>
                                <span class="vesselname">{{changeToNicename(vessel) | titlecase}}</span>
                                <span *ngIf="turbineWarrenty.activeFleet.indexOf(vessel) > -1" class="active">Active</span>
                            </td>
                        </tr>
                        <ng-container *ngIf="isOpen(vessel)">
                            <tr *ngFor="let listing of listings[i]; let ind = index" class="subRow">
                                <td [class.errorListing]="errorListing[i][ind]">
                                    <div class="form-group" [class.firstSubRow]="ind==0">
                                        <div class="input-group datepicker-input">
                                            <input class="form-control form-control-lg" ngbDatepicker #dpStart="ngbDatepicker" name="dpStart" [minDate]="startDate" (ngModelChange)="onChange(listing, i)" 
                                                   [displayMonths]='1' [maxDate]="stopDate" [(ngModel)]="listing.dateStart" placeholder="Start of campaign" readonly (click)="dpStart.toggle()">
                                            <ng-template #customDay let-date="date" let-currentMonth="currentMonth" let-selected="selected" let-disabled="disabled" let-focused="focused">
                                                <div class="custom-day btn-light" [class.bg-primary]="selected" [class.disable-day]="disabled" [class.text-muted]="disabled">
                                                    {{ date.day }}
                                                </div>
                                            </ng-template>
                                            <button class="input-group-addon" (click)="dpStart.toggle()" type="button">
                                                <span class="fa fa-calendar"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="input-group datepicker-input">
                                            <input class="form-control form-control-lg" ngbDatepicker #dpEnd="ngbDatepicker" name="dpEnd" [minDate]="startDate" (ngModelChange)="onChange(listing, i)" 
                                                   [displayMonths]='1' [maxDate]="stopDate" [(ngModel)]="listing.dateEnd" placeholder="End of campaign" readonly (click)="dpEnd.toggle()">
                                            <ng-template #customDay let-date="date" let-currentMonth="currentMonth" let-selected="selected"
                                                         let-disabled="disabled" let-focused="focused">
                                                <div class="custom-day btn-light" [class.bg-primary]="selected" [class.disable-day]="disabled"
                                                     [class.text-muted]="disabled">
                                                    {{ date.day }}
                                                </div>
                                            </ng-template>
                                            <button class="input-group-addon" (click)="dpEnd.toggle()" type="button">
                                                <span class="fa fa-calendar"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <span class="deleteActive" (click)="deleteListing(listing, i)">-</span>
                                    <div *ngIf="errorListing[i][ind]" class="errorListingMsg">The start date can't be after the end date</div>
                                </td>
                            </tr>
                            <tr class="subRow">
                                <td class="new">
                                    <span class="addActive" (click)="setNotNew(i)" >+</span>
                                    <div class="form-group" [class.firstSubRow]="listings[i].length<=0">
                                        <div class="input-group datepicker-input">
                                            <input class="form-control form-control-lg" ngbDatepicker #dpStart="ngbDatepicker" name="dpStart" [minDate]="startDate"
                                                   [displayMonths]='1' [maxDate]="stopDate" [(ngModel)]="datePickerValue[i][0]"
                                                   (ngModelChange)="onChangeNew($event, vessel, true)" placeholder="Start of campaign" readonly (click)="dpStart.toggle()">
                                            <ng-template #customDay let-date="date" let-currentMonth="currentMonth" let-selected="selected" let-disabled="disabled" let-focused="focused">
                                                <div class="custom-day btn-light" [class.bg-primary]="selected" [class.disable-day]="disabled" [class.text-muted]="disabled">
                                                    {{ date.day }}
                                                </div>
                                            </ng-template>
                                            <button class="input-group-addon" (click)="dpStart.toggle()" type="button">
                                                <span class="fa fa-calendar"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="input-group datepicker-input">
                                            <input class="form-control form-control-lg" ngbDatepicker #dpEnd="ngbDatepicker" name="dpEnd" [minDate]="startDate"
                                                   [displayMonths]='1' [maxDate]="stopDate" [(ngModel)]="datePickerValue[i][1]"
                                                   (ngModelChange)="onChangeNew($event, vessel, false)" placeholder="End of campaign" readonly (click)="dpEnd.toggle()">
                                            <ng-template #customDay let-date="date" let-currentMonth="currentMonth" let-selected="selected"
                                                         let-disabled="disabled" let-focused="focused">
                                                <div class="custom-day btn-light" [class.bg-primary]="selected" [class.disable-day]="disabled"
                                                     [class.text-muted]="disabled">
                                                    {{ date.day }}
                                                </div>
                                            </ng-template>
                                            <button class="input-group-addon" (click)="dpEnd.toggle()" type="button">
                                                <span class="fa fa-calendar"></span>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-container>
                    </ng-container>
                </table>
            </div>
            <div class="modal-footer">
                Changes could take up to a day to process
                <button type="button" class="btn btn-primary" (click)="setActive()">Submit</button>
            </div>
        </ng-template>
        <span class="table-legenda">
            <span class="exampleBox gray" [class.hideColor]="hideText==false"><span *ngIf="hideText==false">-</span>&nbsp;</span> not processed
            <span class="exampleBox red" [class.hideColor]="hideText==false"><span *ngIf="hideText==false">0</span>&nbsp;</span> didn't sail
            <span class="exampleBox yellow" [class.hideColor]="hideText==false"><span *ngIf="hideText==false">0.5</span>&nbsp;</span> half sailing day
            <span class="exampleBox green" [class.hideColor]="hideText==false"><span *ngIf="hideText==false">1</span>&nbsp;</span> full sailing day
        </span>
        <table class="table table-hover table-responsive table-bordered sailMatrix">
            <thead>
                <tr>
                    <th class="smallPadding">Date \ Vessel</th>
                    <ng-container *ngFor="let vessel of turbineWarrenty.fullFleet;let ind = index">
                        <th class="smallPadding">
                            <span>{{changeToNicename(vessel) | titlecase}}</span>
                        </th>
                    </ng-container>
                    <th class="smallPadding">
                        <span>Total weather days</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                <ng-container *ngFor="let date of turbineWarrenty.Dates;let ind = index">
                    <tr *ngIf="checkDateRange(date)">
                        <td class="smallPadding">{{MatlabDateToJSDate(date)}}</td>
                        <ng-container *ngFor="let vessel of turbineWarrenty.fullFleet;let i = index">
                            <td [class.green]="sailMatrix[i][ind]==1" [class.red]="sailMatrix[i][ind]==0"
                                [class.yellow]="sailMatrix[i][ind]==0.5" [class.gray]="sailMatrix[i][ind]=='_NaN_'" [class.hideColor]="hideText==false">
                                <span *ngIf="hideText==false && !edit">{{getSailDay(sailMatrix[i][ind])}}</span>
                                <select class="updateSailDay" *ngIf="edit" (change)="updateSailDay(date, vessel, $event.target.value, i, ind)">
                                    <option value="_NaN_" *ngIf="turbineWarrenty.sailMatrix[i][ind]=='_NaN_'" [selected]="sailMatrix[i][ind]=='_NaN_'">-</option>
                                    <option value="0" [selected]="sailMatrix[i][ind]==0">0</option>
                                    <option value="0.5" [selected]="sailMatrix[i][ind]==0.5">0.5</option>
                                    <option value="1" [selected]="sailMatrix[i][ind]==1">1</option>
                                </select>
                            </td>
                            {{addDateSailDay(sailMatrix[i][ind], i)}}
                        </ng-container>
                        <td class="smallPadding">{{getDateWeatherDays()}}</td>
                    </tr>
                </ng-container>
                <tr>
                    <td class="smallPadding">Total weather days</td>
                    <td class="smallPadding" *ngFor="let vessel of turbineWarrenty.fullFleet;let ind = index;">{{getTotalMissingDays(ind)}}</td>
                    <td class="smallPadding">{{getTotalWeatherDays()}}</td>
                </tr>
            </tbody>
        </table>
        <button class="btn" (click)="hideText=!hideText" [disabled]="edit || saving">Toggle color</button>
        <button class="btn" (click)="editData()" *ngIf="!edit">Edit</button>
        <button class="btn" (click)="saveData()" *ngIf="edit" [disabled]="saving">Save</button>
        <button class="btn cancel" (click)="cancelData()" *ngIf="edit" [disabled]="saving">Cancel</button>
    </div>
    <ngb-alert *ngIf="showAlert" [type]="alert.type" (close)="showAlert=false">{{ alert.message }}</ngb-alert>
</div>
